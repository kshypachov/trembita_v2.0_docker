#
# This section builds out the service account more information can be found here: https://kubernetes.io/docs/concepts/security/service-accounts/
serviceAccount:
  # Specifies whether a service account should be created
  create: true
  # Automatically mount a ServiceAccount's API credentials?
  automount: true
  # Annotations to add to the service account
  annotations: {}
  # The name of the service account to use.
  # If not set and create is true, a name is generated using the fullname template
  name: ""

# Main config section for Trembita application
trembita_config:
  # initial jobs section consist configuration parameters for jobs which init file system or DB
  init_jobs:
    # job for init DB, this job upload dumps of all needed databases and tables for trembita
    trembita_postgres:
      name: postgres-init-job
      image: kshypachov/trembita_ss_v1.22.6-pg-init:v1.0.9
      env:
        TZ: Europe/Kyiv
      secrets:
        - postgres
        - postgres4mon2adm
    # job for initialize volumes which filled in section sharedVolumes:
    # job copy files and directirys from base image to volumes
    trembita_volumes:
      name: trembita_volumes_init
      image: kshypachov/trembita_init_img:v1.0.2

# section for define config maps.Config maps will connect to all containers deployed this helm chart
  configMaps:
    enabled: true  # Disable all configmaps and related mountpoints. If all configmaps disabled - need to set @ false @ there
    #ConfigMap not suitable for storing sensitive data like a DB password

    local_ini: # This file readied by all components, there place for adding any configs for any components
      enabled: false
      name: local-ini
      mountPath: /etc/uxp/conf.d/local.ini
      subPath: local.ini

    default_uxp:
      enabled: false
      name: default-uxp
      mountPath: /etc/nginx/sites-enabled/default-uxp
      subPath: default-uxp

    uxp_identity_provider_rest_api:
      enabled: false
      name: uxp-identity-provider-rest-api
      mountPath: /etc/nginx/conf.d/uxp-identity-provider-rest-api-location.include
      subPath: uxp-identity-provider-rest-api-location.include

    uxp_seg_rest_api_ng_include:
      enabled: false
      name: uxp-securityserver-rest-api
      mountPath: /etc/nginx/conf.d/uxp-securityserver-rest-api-location.include
      subPath: uxp-securityserver-rest-api-location.include

    uxp_conf_client_logback:
      enabled: false
      name: conf-client-logback
      mountPath: /etc/uxp/conf.d/confclient-logback.xml
      subPath: confclient-logback.xml

    uxp_message_log_archiver_logback:
      enabled: false
      name: message-log-archiver-logback
      mountPath: /etc/uxp/conf.d/messagelog-archiver-logback.xml
      subPath: messagelog-archiver-logback.xml

    uxp_identity_provider_rest_api_logback:
      enabled: false
      name: identity-provider-rest-api-logback
      mountPath: /etc/uxp/conf.d/identity-provider-rest-api-logback.xml
      subPath: identity-provider-rest-api-logback.xml

    uxp_ocsp_cache_logback:
      enabled: false
      name: ocsp-cache-logback
      mountPath: /etc/uxp/conf.d/ocsp-cache-logback.xml
      subPath: ocsp-cache-logback.xml

    uxp_verifier_logback:
      enabled: false
      name: verifier
      mountPath: /etc/uxp/conf.d/verifier-rest-api-logback.xml
      subPath: verifier-rest-api-logback

    uxp_seg_rest_api_logback:
      enabled: false
      name: seg-rest-api
      mountPath: /etc/uxp/conf.d/securityserver-rest-api-logback.xml
      subPath: securityserver-rest-api-logback.xml

    uxp_proxy_logback:
      enabled: false
      name: proxy-logback
      mountPath: /etc/uxp/conf.d/proxy-logback.xml
      subPath: proxy-logback.xml

    uxp_monitor_agent_logback:
      enabled: false
      name: monitor-agent-logback
      mountPath: /app/proxy-monitor-agent-logback.xml
      subPath: proxy-monitor-agent-logback.xml

    uxp_monitor_agent_addon_logback:
      enabled: false
      name: monitor-agent-addon-logback
      mountPath: /etc/uxp/conf.d/addons/proxy-monitor-agent-logback.xml
      subPath: proxy-monitor-agent-logback.xml

    uxp_anchor:
      enabled: true
      name: uxp-config-anchor
      mountPath: /etc/uxp/configuration-anchor.xml
      subPath: configuration-anchor.xml

    #license for uxp components.
    uxp_license:
      enabled: true
      name: uxp-license
      mountPath: /etc/uxp/license.lic
      subPath: license.lic
    # config file for connecting Gryada 301 HSM
    osplm_ini:
      enabled: true
      name: osplm-ini
      mountPath: /usr/share/uxp/lib/osplm.ini
      subPath: osplm.ini

  secrets:
    healthchecktls:
      enabled: true
      name: trembita-tls-healthcheck
      mountPath: /etc/certs

    identity:
      enabled: true
      name: trembita-identity-provider
      mountPath: /etc/uxp/conf.d/identity-provider.ini
      subPath: identity-provider.ini

    postgres:
      enabled: true
      name: trembita-postgres
      mountPath: /etc/uxp/db.properties
      subPath: db.properties

    postgres4mon2adm:
      enabled: true
      name: trembita-postgres
      mountPath: /etc/uxp/db.monitor-admin
      subPath: db.monitor-admin

# Section for configuration every separate pod
  trembita_configuration_client_pod:  # settins specific for configuration client component
    name: conf-client
    image: kshypachov/trembita_jb_uxp-conf-client-v1.22.7:v1.0.5
    env:
      TZ: Europe/Kyiv
    sharedVolumes: # add name of shared volumes which need to connect to this pod
      - etc-uxp-signer
      - etc-uxp-globalconf
    configMaps:  # add name of config maps which need to connect to this pod
      - uxp_anchor
      - uxp_license
    ephemeralVolumeRAM:
      - name: uxp-conf-client-java-cache # volume in tmpfs
        mountPath: /tmp/java
        sizeLimit: "100Mi"
      - name: uxp-conf-client-dummy # volume re defined by -D option, but still checked
        mountPath: /var/tmp/uxp
        sizeLimit: "2Mi"


  trembita_message_log_archiver_pod:  # settins specific for configuration client component
    name: message-log
    image: kshypachov/trembita_jb_uxp-message-log-archiver-v1.22.7:v1.0.2
    env:
      TZ: Europe/Kyiv
    sharedVolumes: # add name of shared volumes which need to connect to this pod
      - var-lib-uxp-messagelog
    configMaps:  # add name of config maps which need to connect to this pod
    secrets:
      - postgres
    ephemeralVolumeRAM:
      - name: identity-provider-java-cache
        mountPath: /tmp/bc_java/
        sizeLimit: "100Mi"


  trembita_identity_provider_rest_api_pod: # settins specific for configuration client component
    name: identity-rest-api
    image: kshypachov/trembita_jb_uxp-identity-provider-v1.22.7:v1.0.1
    env:
      TZ: Europe/Kyiv
    sharedVolumes: # add name of shared volumes which need to connect to this pod
    configMaps:  # add name of config maps which need to connect to this pod
    secrets:
      - identity
      - postgres
    ephemeralVolumeRAM:
      - name: identity-provider-java-cache
        mountPath: /tmp/bc_java/
        sizeLimit: "100Mi"
      - name: identity-provider-jetty-temp
        mountPath: /tmp/
        sizeLimit: "20Mi"
#    access_tokens:
#      generate_random_tokens: true
#      security_server_client_id: 60997vl7jlgoi53zbyvv2k9iyny1rae2
#      security_server_client_secret: QTK3fBuPu0v0m2DpvEees0AODujEcX3V


  trembita_ocsp_cache_pod:
    name: ocsp-cache
    image: kshypachov/trembita_jb_uxp-ocsp-cache-v1.22.7:v1.0.3
    env:
      TZ: Europe/Kyiv
    sharedVolumes: # add name of shared volumes which need to connect to this pod
      - etc-uxp-globalconf
    configMaps:  # add name of config maps which need to connect to this pod
    secrets:
      - postgres
    ephemeralVolumeRAM:
      - name: ocsp-cache # volume in tmpfs for store ocsp answers
        mountPath: /var/cache/uxp
        sizeLimit: "100Mi"
      - name: ocsp-cache-java-cache
        mountPath: /tmp/bc_java/
        sizeLimit: "100Mi"

  trembita_verifier_pod:
    name: verifier
    image: kshypachov/trembita_jb_uxp-verifier-v1.22.7:v1.0.1
    env:
      TZ: Europe/Kyiv
    sharedVolumes: # add name of shared volumes which need to connect to this pod
      - etc-uxp-globalconf
      - var-lib-uxp-messagelog
    configMaps:  # add name of config maps which need to connect to this pod
      - uxp_anchor
    secrets:
      - identity
      - postgres
    ephemeralVolumeRAM:
      - name: verifier-java-cache
        mountPath: /tmp/bc_java/
        sizeLimit: "100Mi"
      - name: verifier-jetty-cache
        mountPath: /tmp/
        sizeLimit: "20Mi"


  trembita_seg_rest_api_pod:
    name: seg-rest-api
    image: kshypachov/trembita_jb_uxp-seg-rest-api-v1.22.7:v1.0.3
    env:
      TZ: Europe/Kyiv
      PKCS11_PROXY_SOCKET: tcp://94.131.252.139:23454
    sharedVolumes: # add name of shared volumes which need to connect to this pod
      - etc-uxp-signer
      - etc-uxp-globalconf
    configMaps: # add name of config maps which need to connect to this pod
      - uxp_anchor
      - uxp_license
      - osplm_ini
    secrets:
      - identity
      - postgres
    ephemeralVolumeRAM:
      - name: seg-rest-api-java-cache
        mountPath: /tmp/bc_java/
        sizeLimit: "100Mi"
      - name: seg-rest-api-jetty-cache
        mountPath: /tmp/
        sizeLimit: "20Mi"


  trembita_proxy_pod:
    name: proxy
    image: kshypachov/trembita_jb_uxp-proxy-v1.22.7:v1.1.0
    env:
      TZ: Europe/Kyiv
      UXP_TOKENS_PASS: "0:1234"
      PKCS11_PROXY_SOCKET: tcp://94.131.252.139:23454
    sharedVolumes: # add name of shared volumes which need to connect to this pod
      - etc-uxp-signer
      - var-lib-uxp-messagelog
      - etc-uxp-globalconf
    configMaps: # add name of config maps which need to connect to this pod
      - uxp_anchor
      - uxp_license
      - osplm_ini
    secrets:
      - healthchecktls
      - postgres
    ingress:
      host: api.trembita.office
      secure_host: secure-api.trembita.office
    ephemeralVolumeRAM:
      - name: proxy-java-cache
        mountPath: /tmp/bc_java/
        sizeLimit: "100Mi"


  trembita_monitor_pod:
    name: monitor
    image: kshypachov/trembita_jb_uxp-monitor-agent-v1.22.7:v1.0.5
    env:
      TZ: Europe/Kyiv
    sharedVolumes: # add name of shared volumes which need to connect to this pod
      - etc-uxp-signer
      - etc-uxp-globalconf
    configMaps:  # add name of config maps which need to connect to this pod
      - uxp_anchor
      - uxp_license
#      - uxp_monitor_agent_logback
    secrets:
      - postgres
    ephemeralVolumeRAM:
      - name: monitor-java-cache # volume in tmpfs for store ocsp answers
        mountPath: /tmp/bc_java/
        sizeLimit: "100Mi"

  trembita_frontend_pod:
    name: frontend
    image:  kshypachov/trembita_frontend_v1.22.7:v1.0.6
    env:
      TZ: Europe/Kyiv
    sharedVolumes: # add name of shared volumes which need to connect to this pod
    configMaps: # add name of config maps which need to connect to this pod
      - default_uxp
      - uxp_identity_provider_rest_api
      - uxp_seg_rest_api_ng_include
    ingress:
      host: trembita.office
    ephemeralVolumeRAM:
      - name: nginx-tmp # volume in tmpfs for store nginx tep files
        mountPath: /tmp/nginx
        sizeLimit: "20Mi"

  trembita_postgresql_pod:
    name: postgres
    image: postgres:16
    env:
      TZ: Europe/Kyiv
      PGDATA: /var/lib/postgresql/data/pgdata
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: mysecretpassword
      POSTGRES_DB: appdb

    persistentStorage:
      - name: postgres
        mountPath: /var/lib/postgresql/data
        size: 1Gi
        storageClass: ""

  sharedVolumes: # volumes which will connect to all trembita pods in this chart. Data will copy from original image (entire tembita server) during init phase
    # volume for store trensactions
    var-lib-uxp-messagelog:
      enabled: true
      initCopy: false
      size: 2Gi
      mountPath: /var/lib/uxp/messagelog/
      # Storage class that provides ReadWriteMany access for multiple pods
      storageClassName: "longhorn-rwx"
      accessModes:
        - ReadWriteMany
    # volume for store global configuration
    etc-uxp-globalconf:
      enabled: true
      initCopy: true
      size: 200Mi
      mountPath: /etc/uxp/globalconf/
      # Storage class that provides ReadWriteMany access for multiple pods
      storageClassName: "longhorn-rwx"
      accessModes:
        - ReadWriteMany
    # volume for store soft tokens
    etc-uxp-signer:
      enabled: true
      initCopy: true
      size: 50Mi
      mountPath: /etc/uxp/signer/
      # Storage class that provides ReadWriteMany access for multiple pods
      storageClassName: "longhorn-rwx"
      accessModes:
        - ReadWriteMany



minio:
#  nameOverride: "minio"
  fullnameOverride: minio
  auth:
    rootUser: minioadmin
    rootPassword: minioadmin
  defaultBuckets: uxp-messagelog
  mode: standalone
  persistence:
    enabled: true
    size: 1Gi
  ingress:
    enabled: true
    ingressClassName: "nginx"
    hostname: minio.trembita.office

  apiIngress:
    enabled: true
    ingressClassName: "nginx"
    hostname: api.minio.trembita.office