# uxp-configuration-client Kubernetes Deployment

Этот каталог содержит шаблоны для развертывания службы `uxp-configuration-client` в Kubernetes.

## Описание

Шаблон `configuration-client.yaml` описывает ресурс типа `Deployment`, состоящий из одного `Pod`, содержащего два контейнера:

- **sidecar** — служит для проксирования локального порта;
- **uxp-configuration-client** — основное Java-приложение для загрузки и обработки глобальной конфигурации X-Road (Trembita).

Поскольку основной контейнер слушает **порт 5666 на интерфейсе 127.0.0.1**, доступ к нему извне невозможен напрямую. Для решения этой задачи используется sidecar-контейнер с `socat`, который проксирует:

```
0.0.0.0:6666 → 127.0.0.1:5666
```

Это позволяет другим компонентам кластера обращаться к порту 5666 через сервис на 6666 порту.

## Сервис

Файл `configuration-client-admin-port-service.yaml` содержит описание Kubernetes `Service`, обеспечивающего доступ к admin-порту контейнера через `socat`.

## Особенности конфигурации

- Основное Java-приложение запускается с явно заданными параметрами `command` и `args`, что позволяет легко документировать и изменять конфигурацию без пересборки контейнера.
- Контейнер работает в **read-only** файловой системе. Для корректной работы необходимо примонтировать внешние тома:
  - Для временных файлов Java и библиотеки `javacpp` (`/tmp/java`, `/var/tmp/uxp/`);
  - Для хранения загруженной глобальной конфигурации.

## Ресурсы

### sidecar (socat)

| Параметр  | Значение    |
|-----------|-------------|
| CPU       | 10m (req), 20m (limit) |
| Memory    | 32Mi (req), 64Mi (limit) |
| Порт      | 6666        |

### uxp-configuration-client

| Параметр  | Значение    |
|-----------|-------------|
| CPU       | 100m (req), 200m (limit) |
| Memory    | 128Mi (req), 256Mi (limit) |
| Порт      | 5666        |

## Назначение

Служба используется для загрузки глобальной конфигурации X-Road и может быть вызвана другими службами системы через проксированный admin-порт.

---

**Примечание:** Файл запуска `configuration-client.jar` использует дополнительные зависимости, переданные через `-cp`, включая `cipher-jce-provider`, `ciplus-jce`, и прочие.

```bash
java -Xmx50m \
     -XX:MaxMetaspaceSize=70m \
     -XX:+UseG1GC \
     -Xshare:on \
     -Duxp.configuration-client.port=5665 \
     ...
     ee.cyber.uxp.common.conf.globalconf.ConfigurationClientMain
```